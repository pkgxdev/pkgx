name: CD

on:
  push:
    branches:
      - main
    paths:
      - README.md
      - .github/workflows/cd.yml
  workflow_dispatch:

concurrency:
  group: distribute
  cancel-in-progress: true

env:
  VERBOSE: 1
  TEA_SECRET: ${{ secrets.TEA_SECRET }}

permissions:
  actions: write
  repository-projects: read
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      commence: ${{ steps.rev-parse.outputs.result == 'commence' }}
    steps:
      - uses: actions/checkout@v3

      #TMP until we go public
      - run: .github/mk-pantry-accessible.sh ${{ secrets.TEMP_JACOBS_GITHUB_PAT }}

      - uses: teaxyz/setup@v0

      - id: extract
        name: determine current version
        run: |
          source <(tea -Eds)
          echo "::set-output name=version::$VERSION"
          if test x$VERSION = x; then exit 1; fi
        env:
          VERBOSE: 0

      - id: rev-parse
        name: did we already publish this version?
        run: |
          # fetch tags since actions/checkout is a shallow checkout
          git fetch --prune --unshallow --tags

          if git show-ref --tags v${{ steps.extract.outputs.version }} --quiet; then
            echo "::set-output name=result::cancel"
          else
            echo "::set-output name=result::commence"
          fi

      - uses: andymckay/cancel-action@0.2
        if: ${{ steps.rev-parse.outputs.result == 'cancel' }}

  ci:
    needs: [check]
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  release:
    permissions:
      contents: write
    needs: [check, ci]
    runs-on: ubuntu-latest
    env:
      TAG: v${{ needs.check.outputs.version }}
    steps:
      - uses: actions/checkout@v3

      #TODO find a release action that will tag atomically
      # the GitHub API does this so it is frankly unacceptable the action refuses
      - run: |
          git tag ${{ env.TAG }}
          git push origin ${{ env.TAG }}

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          fail_on_unmatched_files: true
          token: ${{ secrets.TEMP_JACOBS_GITHUB_PAT }}
          # ^^ using our own PAT since otherwise vx-tagger wonâ€™t run
